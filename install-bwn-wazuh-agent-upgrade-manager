#!/bin/bash

#
# install-bwn-wazuh-agent-upgrade-manager
# Install Blue Wolf Ninja Wazuh Agent Upgrade Manager
#
# Confirm python3 is present.
# Move the bwn-wazuh-agent-upgrade-manager.py script from the current working directory to /opt/bwn-wazuh-agent-upgrade-manager/bin/ and make it executable.
# Create a Python virtual environment with needed pip dependencies, under /opt/bwn-wazuh-agent-upgrade-manager/bin/
# Symlink /usr/local/bwn-wazuh-agent-upgrade-manager to /opt/bwn-wazuh-agent-upgrade-manager/bin/bwn-wazuh-agent-upgrade-manager.py
#
# Before running this, download the latest version of bwn-wazuh-agent-upgrade-manager.py
# curl https://raw.githubusercontent.com/BlueWolfNinja/wazuh-resources/refs/heads/main/bwn-wazuh-agent-upgrade-manager.py > ./upgrade-wazuh-agents.py
#

set -e

VENV_DIR="venv"
PYTHON_BIN="${PYTHON_BIN:-python3}"

# Default packages
PACKAGES=("jq" "opensearch-py" "python-dateutil")

# Check for root or sudo privileges
if [ "$EUID" -ne 0 ]; then
  echo "⚠️  Please run this script as root or with sudo."
  exit 1
fi

# --- Function: Detect Linux distribution ---
detect_distro() {
  if [ -f /etc/os-release ]; then
    . /etc/os-release
    echo "$(echo "$ID" | tr '[:upper:]' '[:lower:]')"
  else
    echo "unknown"
  fi
}

DISTRO=$(detect_distro)
echo "🖥️  Detected distro: $DISTRO"

# --- Function: Install python3-venv or equivalent ---
install_venv_package() {
  echo "⚙️ Installing python3-venv or equivalent..."
  case "$DISTRO" in
    ubuntu|debian|pop|linuxmint)
      apt update -y
      apt install -y python3-venv
      ;;
    fedora|rhel|centos|rocky|almalinux)
      dnf install -y python3-virtualenv python3-pip || yum install -y python3-virtualenv python3-pip
      ;;
    opensuse*|sles)
      zypper install -y python3-virtualenv python3-pip
      ;;
    arch|manjaro)
      pacman -Sy --noconfirm python python-pip
      ;;
    alpine)
      apk add --no-cache py3-venv py3-pip
      ;;
    *)
      echo "❌ Unsupported distro. Please install venv/ensurepip manually."
      exit 1
      ;;
  esac
}

# --- Function: Check for venv availability ---
check_venv() {
  $PYTHON_BIN -m venv --help >/dev/null 2>&1
}

# --- Function: Check for ensurepip availability ---
check_ensurepip() {
  $PYTHON_BIN -m ensurepip --version >/dev/null 2>&1
}

# --- Ensure Python 3 exists ---
if ! command -v $PYTHON_BIN >/dev/null 2>&1; then
  echo "❌ Python 3 is not installed on this system."
  echo "Please install Python 3 manually before running this script."
  echo "On Ubuntu/Debian: sudo apt install python3 python3-pip python3-venv"
  echo "On Fedora/RHEL: sudo dnf install python3 python3-pip python3-venv"
  echo "On Alpine: sudo apk add python3 py3-pip py3-venv"
  exit 1
else
  echo "✅ Python 3 is present."
fi

# --- Ensure venv module exists ---
if ! check_venv; then
  echo "⚙️  Python venv module not found. Installing..."
  install_venv_package
  if ! check_venv; then
    echo "❌ Failed to enable venv module even after installation."
    exit 1
  fi
else
  echo "✅ Python venv module is available."
fi

# --- Ensure ensurepip module exists ---
if ! check_ensurepip; then
  echo "⚙️ Python ensurepip module not found. Installing..."
  install_venv_package
  if ! check_ensurepip; then
    echo "❌ Failed to enable ensurepip module even after installation."
    exit 1
  fi
else
  echo "✅ Python ensurepip module is available."
fi

# --- Ensure bwn-wazuh-agent-upgrade-manager exists ---
if [ ! -f "./bwn-wazuh-agent-upgrade-manager.py" ]; then
  echo "❌ File './upgrade-wazuh-agents.py' not found."
  echo "Please download it with the following command before proceeding:"
  echo "  curl https://raw.githubusercontent.com/BlueWolfNinja/wazuh-resources/refs/heads/main/bwn-wazuh-agent-upgrade-manager.py > ./bwn-wazuh-agent-upgrade-manager.py"
  exit 1
else
  echo "✅ Found './bwn-wazuh-agent-upgrade-manager.py'."
fi

# Put the Python script in place under /opt, symlinked and made executable.
rm /opt/bwn-wazuh-agent-upgrade-manager -rf 2> /dev/null
mkdir -p /opt/bwn-wazuh-agent-upgrade-manager/bin/
mv ./bwn-wazuh-agent-upgrade-manager.py /opt/bwn-wazuh-agent-upgrade-manager/bin/
chmod 744 /opt/bwn-wazuh-agent-upgrade-manager/bin/bwn-wazuh-agent-upgrade-manager.py
rm /usr/local/bin/bwn-wazuh-agent-upgrade-manager 2> /dev/null
ln -s /opt/bwn-wazuh-agent-upgrade-manager/bin/bwn-wazuh-agent-upgrade-manager.py /usr/local/bin/bwn-wazuh-agent-upgrade-manager

# --- Create and configure virtual environment ---
cd /opt/bwn-wazuh-agent-upgrade-manager/
echo "📦 Creating virtual environment in: $VENV_DIR"
$PYTHON_BIN -m venv "$VENV_DIR"

PIP_PATH="$VENV_DIR/bin/pip"

echo "⬆️  Upgrading pip..."
"$PIP_PATH" install --upgrade pip

# Install required packages only
echo "📦 Installing pip packages: ${PACKAGES[*]}"
"$PIP_PATH" install "${PACKAGES[@]}"

